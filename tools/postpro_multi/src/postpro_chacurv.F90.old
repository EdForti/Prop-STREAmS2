module postpro_chacurv
 use parameters
 use global_variables 
 use reader
 use derivatives
 use comp_transform

 contains 

 subroutine stats1d_curv
 implicit none
 integer, parameter :: np     = 7  ! Number of points for interpolation
 integer, parameter :: naux   = 3  ! Number of auxiliary variables for compressibility transformations 
 real(rkind), dimension(ny)   :: u, dudy
 real(rkind), dimension(:,:), allocatable :: wstat1d
 real(rkind), dimension(:,:), allocatable :: w1dh
 real(rkind), dimension(np) :: fvec,yvec
 real(rkind), dimension(1-ng:ny/2+ng) :: yint,yext
 real(rkind), dimension(ny/2) :: yvd,yt,yv,ut,uvd,uv
 real(rkind), dimension(naux,ny/2) :: vaux
 real(rkind) :: yy,rho,dudyw,rhowall,drhodyw,d2rhodyw
 real(rkind) :: rhowall_i,rhowall_o,muwall_i,muwall_o,utau_i,utau_o
 real(rkind) :: uwall,d2udyw
 real(rkind) :: qw,Twall,dTdyw,d2Tdyw,Ttau
 real(rkind) :: ufav(ny/2),vfav(ny/2),wfav(ny/2),uuu(ny)
 real(rkind) :: ufav_tot(ny),vfav_tot(ny),wfav_tot(ny),uuu_tot(ny),ulam(ny)
 real(rkind) :: uu,muwall,nuwall,retau,deltav,utau,tauw
 real(rkind) :: pp,tt,tt2,pp2,rho2,rhou2,rhov2,rhow2,rhouv
 real(rkind) :: ri2, ro2, rc2
 real(rkind) :: aa,alfa,bb,beta,rr,ubulk,umax1,umax2,umaxlam,umean,usum,uu2,vlam,vpoi,vv2,ww2
 integer :: i,j,m
 character(20) :: tname
 real(rkind) :: d1, d2, x10, xc1, b1, c1, u1, dudyw_streams1, dudyw_simple

 allocate(wstat1d(nv,ny))
 allocate(w1dh(nv,ny/2))

 call read_grid_cha

 wstat1d = 0._rkind
 do i=1,nx
  do j=1,ny
   do m=1,nv
    wstat1d(m,j) = wstat1d(m,j) + wstat(i,j,m)
   enddo
  enddo
 enddo
 wstat1d = wstat1d/nx
!
!-----------------------------------------------------------------------------------
! CONVEX
!-----------------------------------------------------------------------------------
 w1dh(:,:) = wstat1d(:,1:ny/2)
 yint(1-ng:ny/2+ng) = y(1-ng:ny/2+ng) - R_curv

 do j=1,ny/2
  ufav(j) = w1dh(13,j)/w1dh(1,j)
  vfav(j) = w1dh(14,j)/w1dh(1,j)
  wfav(j) = w1dh(15,j)/w1dh(1,j)
 enddo
!
 call ddy(ny/2,ufav,yint(1:ny/2),6,dudy)
!
!Interpolate rho at the wall
 fvec = w1dh(1,1:np)
 yvec = yint(1:np)
 call interpolate(np,fvec,yvec,-1._rkind,rhowall,drhodyw,d2rhodyw)
!
!Compute dudy at the wall
 fvec = ufav(1:np)
 call interpolate(np,fvec,yvec,-1._rkind,uwall,dudyw,d2udyw)
 open(unit=111, file="debug.log")
 write(111,*)yvec(1), fvec(1)
 write(111,*)yvec(2), fvec(2)
 write(111,*)yvec(3), fvec(3)
 write(111,*)yvec(4), fvec(4)
 write(111,*)yvec(5), fvec(5)
 write(111,*)yvec(6), fvec(6)
 write(111,*)yvec(7), fvec(7)
 close(111)

 d1  = yint(1)+1._rkind      ! dy(1)/2
 d2  = yint(2)+1._rkind      ! dy(1)   + dy(2)/2
 x10 = yint(2)-yint(1)       ! dy(1)/2 + dy(2)/2
 xc1 = yn(2) + 1._rkind      ! dy(1)
 b1 = (ufav(2)-ufav(1))/x10  ! u'(dy(1))
 c1 = ufav(1) - b1*d1        ! u(0)
 u1 = c1 + b1*xc1            ! u(dy(1))
 dudyw_streams1 = u1 / (yn(2)-yn(1))
 dudyw_simple = ufav(1)/d1
 print*,'dudyw in 3 modi: ',dudyw, dudyw_streams1, dudyw_simple
 dudyw = dudyw_streams1
! 
!Compute dTdy at the wall
 fvec = w1dh(6,1:np) 
 call interpolate(np,fvec,yvec,-1._rkind,Twall,dTdyw,d2Tdyw)
!Uncoment for second order accurate approximation of dudyw
!call ddyw_staggered(ny/2,ufav,y(1:ny/2),-1._rkind,dudyw)
!
 muwall = mu0
 nuwall = muwall/rhowall
 tauw   = muwall*dudyw
 utau   = sqrt(tauw/rhowall)
 deltav = nuwall/utau
 retau  = l0/deltav
!
 rhowall_i = rhowall
 muwall_i  = muwall
 utau_i    = utau
!
 Twall = t0
 qw    =-k0*dTdyw
 Ttau  = qw/(rhowall*cp0*utau)

 print*, 'Convex side'
 print*,'*************************************************************************'
 print*, 'rho_w =',rhowall, '   ','mu_w      =',muwall
 print*, 'dudyw =',dudyw,   '   ','dTdyw     =',dTdyw
 print*, 'tau_w =',tauw,    '   ','u_tau     =',utau
 print*, 'retau =',retau, '     ','u+ (ny/2) =',ufav(ny/2)/utau
 print*,'*************************************************************************'
!
! Compute compressibility transformations
!
 vaux(1,:) = w1dh(1,:)/rhowall 
 vaux(2,:) = w1dh(21,:)/nuwall 
 vaux(3,:) = w1dh(20,:)/muwall 
!
 tname = 'TrettelLarsson'
 call transform(1,ny/2,yint(1:ny/2),ufav(1:ny/2),naux,vaux,yt,ut,tname)
!
 tname = 'vanDriest'
 call transform(1,ny/2,yint(1:ny/2),ufav(1:ny/2),naux,vaux,yvd,uvd,tname)
!
 tname = 'Volpiani'
 call transform(1,ny/2,yint(1:ny/2),ufav(1:ny/2),naux,vaux,yv,uv,tname)
!
 open(10,file='POSTPRO/channinfo_convex.dat',form='formatted')
 write(10,*)'Retau,          rho_wall,         utau/u0,         Cf'
 write(10,*)retau,rhowall,utau/u0,2._rkind*tauw/(rho0*u0**2)
 close(10)
!
 open(10,file='POSTPRO/channstat_convex.prof',form='formatted')
 do j=1,ny/2
  yy   = yint(j)+1.
  rho  = w1dh(1,j) 
  tt   = w1dh(6,j) 
  pp   = w1dh(5,j) 
  uu   = ufav(j)
  rhou2  = w1dh(16,j) - w1dh(13,j)**2/w1dh(1,j) 
  rhov2  = w1dh(17,j) - w1dh(14,j)**2/w1dh(1,j)
  rhow2  = w1dh(18,j) - w1dh(15,j)**2/w1dh(1,j) 
  rhouv  = w1dh(19,j) - w1dh(13,j)*w1dh(14,j)/w1dh(1,j)
  rho2   = w1dh(7,j)  - rho**2
  pp2    = w1dh(11,j) - pp**2 
  tt2    = w1dh(12,j) - tt**2 
  write(10,100)yy,          &         !1  y/h
               yy/deltav,   &         !2  y^+
               yt(j)/deltav,&         !3  y_T^+
               uu/u0,       &         !4  u/u_b
               uu/utau,     &         !5  u^+
               uvd(j)/utau, &         !6  u_VD^+
               ut(j)/utau,  &         !7  u_TL^+
               rho/rhowall, &         !8  rho/rhowall
               rhou2/tauw,  &         !9  rho/rhowall*u2^+   
               rhov2/tauw,  &         !10 rho/rhowall*v2^+  
               rhow2/tauw,  &         !11 rho/rhowall*w2^+ 
               rhouv/tauw,  &         !12 rho/rhowall*uv^+
               tt/Twall,    &         !13 Temp/Twall
               rho2/rhowall,&         !14 rho/rhowall
               tt2/Twall**2,&         !15 T2/Twall
               (tt-Twall)/Ttau,     & !16 T^+
               tt2/Ttau**2, &         !17 T2^+
               yv(j)/deltav,&         !18 y_V^+
               uv(j)/utau             !19 u_v^+
              

 enddo
 close(10)

!-----------------------------------------------------------------------------------
! CONCAVE
!-----------------------------------------------------------------------------------
 w1dh(:,:) = wstat1d(:,ny:ny/2+1:-1)
 yext(1-ng:ny/2+ng) = -y(ny+ng:ny/2-ng:-1)+R_curv

 do j=1,ny/2
  ufav(j) = w1dh(13,j)/w1dh(1,j)
  vfav(j) = w1dh(14,j)/w1dh(1,j)
  wfav(j) = w1dh(15,j)/w1dh(1,j)
 enddo
!
 call ddy(ny/2,ufav,yext(1:ny/2),6,dudy)
!
!Interpolate rho at the wall
 fvec = w1dh(1,1:np)
 yvec = yext(1:np)
 call interpolate(np,fvec,yvec,-1._rkind,rhowall,drhodyw,d2rhodyw)
!
!Compute dudy at the wall
 fvec = ufav(1:np)
 call interpolate(np,fvec,yvec,-1._rkind,uwall,dudyw,d2udyw)

 d1  = yext(1)+1._rkind         ! dy(1)/2
 d2  = yext(2)+1._rkind         ! dy(1)   + dy(2)/2
 x10 = yext(2)-yext(1)             ! dy(1)/2 + dy(2)/2
 xc1 = yn(2) + 1._rkind      ! dy(1)
 b1 = (ufav(2)-ufav(1))/x10  ! y'(dy(1))
 c1 = ufav(1) - b1*d1        ! u(0)
 u1 = c1 + b1*xc1
 dudyw_streams1 = u1 / (yn(2)-yn(1))
 print*,'dudyw in 2 modi: ',dudyw, dudyw_streams1
 dudyw = dudyw_streams1
! 
!Compute dTdy at the wall
 fvec = w1dh(6,1:np) 
 call interpolate(np,fvec,yvec,-1._rkind,Twall,dTdyw,d2Tdyw)
!Uncoment for second order accurate approximation of dudyw
!call ddyw_staggered(ny/2,ufav,y(1:ny/2),-1._rkind,dudyw)
!
 muwall = mu0
 nuwall = muwall/rhowall
 tauw   = muwall*dudyw
 utau   = sqrt(tauw/rhowall)
 deltav = nuwall/utau
 retau  = l0/deltav
!
 rhowall_o = rhowall
 muwall_o  = muwall
 utau_o    = utau
!
 Twall = t0
 qw    =-k0*dTdyw
 Ttau  = qw/(rhowall*cp0*utau)

 print*, 'Concave side'
 print*,'*************************************************************************'
 print*, 'rho_w =',rhowall, '   ','mu_w      =',muwall
 print*, 'dudyw =',dudyw,   '   ','dTdyw     =',dTdyw
 print*, 'tau_w =',tauw,    '   ','u_tau     =',utau
 print*, 'retau =',retau, '     ','u+ (ny/2) =',ufav(ny/2)/utau
 print*,'*************************************************************************'
!
! Compute compressibility transformations
!
 vaux(1,:) = w1dh(1,:)/rhowall 
 vaux(2,:) = w1dh(21,:)/nuwall 
 vaux(3,:) = w1dh(20,:)/muwall 
!
 tname = 'TrettelLarsson'
 call transform(1,ny/2,yext(1:ny/2),ufav(1:ny/2),naux,vaux,yt,ut,tname)
!
 tname = 'vanDriest'
 call transform(1,ny/2,yext(1:ny/2),ufav(1:ny/2),naux,vaux,yvd,uvd,tname)
!
 tname = 'Volpiani'
 call transform(1,ny/2,yext(1:ny/2),ufav(1:ny/2),naux,vaux,yv,uv,tname)
!
 open(10,file='POSTPRO/channinfo_concave.dat',form='formatted')
 write(10,*)'Retau,          rho_wall,         utau/u0,         Cf'
 write(10,*)retau,rhowall,utau/u0,2._rkind*tauw/(rho0*u0**2)
 close(10)
!
 open(10,file='POSTPRO/channstat_concave.prof',form='formatted')
 do j=1,ny/2
  yy   = yext(j)+1.
  rho  = w1dh(1,j) 
  tt   = w1dh(6,j) 
  pp   = w1dh(5,j) 
  uu   = ufav(j)
  rhou2  = w1dh(16,j) - w1dh(13,j)**2/w1dh(1,j) 
  rhov2  = w1dh(17,j) - w1dh(14,j)**2/w1dh(1,j)
  rhow2  = w1dh(18,j) - w1dh(15,j)**2/w1dh(1,j) 
  rhouv  = w1dh(19,j) - w1dh(13,j)*w1dh(14,j)/w1dh(1,j)
  rho2   = w1dh(7,j)  - rho**2
  pp2    = w1dh(11,j) - pp**2 
  tt2    = w1dh(12,j) - tt**2 
  write(10,100)yy,          &         !1  y/h
               yy/deltav,   &         !2  y^+
               yt(j)/deltav,&         !3  y_T^+
               uu/u0,       &         !4  u/u_b
               uu/utau,     &         !5  u^+
               uvd(j)/utau, &         !6  u_VD^+
               ut(j)/utau,  &         !7  u_TL^+
               rho/rhowall, &         !8  rho/rhowall
               rhou2/tauw,  &         !9  rho/rhowall*u2^+   
               rhov2/tauw,  &         !10 rho/rhowall*v2^+  
               rhow2/tauw,  &         !11 rho/rhowall*w2^+ 
               rhouv/tauw,  &         !12 rho/rhowall*uv^+
               tt/Twall,    &         !13 Temp/Twall
               rho2/rhowall,&         !14 rho/rhowall
               tt2/Twall**2,&         !15 T2/Twall
               (tt-Twall)/Ttau,     & !16 T^+
               tt2/Ttau**2, &         !17 T2^+
               yv(j)/deltav,&         !18 y_V^+
               uv(j)/utau             !19 u_v^+
              

 enddo
 close(10)

!-----------------------------------------------------------------------------------
! GLOBAL
!-----------------------------------------------------------------------------------
  ri2 = (R_curv-1._rkind)*(R_curv-1._rkind)
  ro2 = (R_curv+1._rkind)*(R_curv+1._rkind)
  rc2 = (R_curv*R_curv)*2._rkind

  do j=1,ny
   uuu_tot(j) = wstat1d(2,j)
   ufav_tot(j) = wstat1d(13,j)/wstat1d(1,j)
   vfav_tot(j) = wstat1d(14,j)/wstat1d(1,j)
   wfav_tot(j) = wstat1d(15,j)/wstat1d(1,j)
  enddo

  rhowall = 0.5_rkind*(rhowall_i+rhowall_o)
  muwall  = 0.5_rkind*(muwall_i+muwall_o)
  utau    = sqrt((ri2*(utau_i*utau_i)+ro2*(utau_o*utau_o))/rc2)
  retau   = rhowall * utau / muwall
  print*, 'Global re_tau =', retau
  umax1  = maxval(ufav_tot)/u0
  umax2  = maxval(uuu)/u0
  aa = R_curv - 1._rkind
  bb = R_curv + 1._rkind
  alfa = (bb**2*log(bb)-aa**2*log(aa))/(bb**2-aa**2)
  beta = (aa**2*bb**2) * log(bb/aa)   /(bb**2-aa**2)
  umean = (0.25_rkind*(bb**2-aa**2)-(aa**2*bb**2)*(log(bb/aa))**2/(bb**2-aa**2))/(bb-aa)
  usum = 0._rkind
  do j=1,ny
    rr = yn(j) + R_curv       
    ulam(j) = alfa*rr-beta/rr-rr*log(rr)
    usum = usum + ufav_tot(j)
  enddo
  umaxlam  = maxval(ulam)/umean
  ubulk = usum/ny
  !print*, 'u_bulk', u0, ubulk
  !print*, 'u_max =', maxval(ufav_tot), 'u_center =', ufav_tot(ny/2)
!
  open(unit=10,file='POSTPRO/channstat_global.prof',form='formatted')
  do j=1,ny
   yy   = y(j) - R_curv
   vpoi = 1.5_rkind*(1._rkind-yy*yy)
   !vlam = ulam(j)/umaxlam 
   vlam = (alfa*y(j)-beta/y(j)-y(j)*log(y(j)))
   uu2  = wstat1d(16,j)/wstat1d(1,j) - ufav_tot(j)*ufav_tot(j)
   vv2  = wstat1d(17,j)/wstat1d(1,j) - vfav_tot(j)*vfav_tot(j)
   ww2  = wstat1d(18,j)/wstat1d(1,j) - wfav_tot(j)*wfav_tot(j)
   uv   = wstat1d(19,j)/wstat1d(1,j) - ufav_tot(j)*vfav_tot(j)
   !tauv = w_av(20,j)*w_av(21,j)
   !omz2 = w_av(25,j)-w_av(22,j)**2
   !omx2 = w_av(26,j)-w_av(23,j)**2
   !omy2 = w_av(27,j)-w_av(24,j)**2
!
   write(10,100) yy, &                !y/h
                 !vpoi,&
                 !vlam/umean,&
                 !ulam(j)/umean,&
                 ufav_tot(j)/u0,&         !u/u_b
                 uuu(j)/u0,&          !u/u_b
                 !ufav_tot(j)/ubulk,&     !u/u_b
                 uu2/utau**2,&        !u2^+
                 vv2/utau**2,&        !v2^+
                 ww2/utau**2,&        !w2^+
                 uv /utau**2!,&       !uv^+
                 !tauv/tauw,&         !tau_visc
                 !omz2,&
                 !omx2,&
                 !omy2
  enddo
  close(10)

 100  format(200ES20.10)
 end subroutine stats1d_curv

end module postpro_chacurv
